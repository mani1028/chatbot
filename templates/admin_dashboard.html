<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | ChatbotX SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Specific override for the simulator to make it large */
        .simulator-frame {
            width: 100%;
            height: 85vh; /* Occupy 85% of the viewport height */
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <span>‚ö°</span> ChatbotX <span class="badge-pro">PRO</span>
        </div>
        
        <nav class="nav-links">
            <div class="nav-item active" onclick="switchTab('config', this)">
                <span>‚öôÔ∏è</span> Configuration
            </div>
            <div class="nav-item" onclick="switchTab('branding', this)">
                <span>üé®</span> Branding
            </div>
            <div class="nav-item" onclick="switchTab('install', this)">
                <span>üîå</span> Installation
            </div>
            <div class="nav-item" onclick="switchTab('simulator', this)">
                <span>üì±</span> Simulator
            </div>
        </nav>

        <div class="user-profile">
            <div class="user-info">
                <span>Site ID: <b>{{ site_id }}</b></span>
                <small class="status-online">‚óè System Online</small>
            </div>
            <a href="/admin/logout" class="logout-link">Log Out</a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- 1. CONFIGURATION TAB -->
        <div id="config" class="tab-panel active">
            <div class="header">
                <h1>Service Configuration</h1>
                <p>Manage your AI behavior and business logic.</p>
            </div>

            <div class="config-section">
                <form id="configForm">
                    <div class="form-group">
                        <label>Consultation Price (Currency)</label>
                        <input type="text" name="consultation_price" class="form-control" placeholder="e.g. 500">
                        <small>Used by the AI to answer pricing questions.</small>
                    </div>

                    <div class="form-group">
                        <label>Operating Hours</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <input type="text" name="open_time" class="form-control" placeholder="Opens (e.g. 9 AM)">
                            <input type="text" name="close_time" class="form-control" placeholder="Closes (e.g. 6 PM)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>AI Mode</label>
                        <select name="ai_mode" class="form-control">
                            <option value="on">‚úÖ Enabled (Auto-Reply)</option>
                            <option value="off">‚ùå Disabled (Human Only)</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-save">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. BRANDING TAB -->
        <div id="branding" class="tab-panel">
            <div class="header">
                <h1>Branding & Design</h1>
                <p>Customize the look and feel to match your brand identity.</p>
            </div>
            
            <div class="branding-container">
                <div class="config-section">
                    <form id="brandingForm">
                        <div class="form-group">
                            <label>Bot Name</label>
                            <input type="text" name="bot_name" class="form-control" placeholder="e.g. Apollo Assistant">
                        </div>
                        
                        <div class="form-group">
                            <label>Welcome Message</label>
                            <textarea name="initial_message" class="form-control" rows="3" placeholder="Hi! How can I help you?"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Theme Mode</label>
                            <select name="theme_mode" class="form-control">
                                <option value="light">‚òÄÔ∏è Light Mode</option>
                                <option value="dark">üåô Dark Mode</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Brand Color</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="color" name="primary_color" id="colorPicker" value="#6366f1">
                                <span id="colorHex">#6366f1</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Widget Position</label>
                            <select name="position" class="form-control">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-save">Update Design</button>
                    </form>
                </div>

                <!-- Live Mobile Preview -->
                <div class="phone-mockup">
                    <div class="phone-screen">
                        <div class="sim-header" id="simHeader">
                            <div class="sim-avatar"></div>
                            <span id="simName">Bot Name</span>
                        </div>
                        <div class="sim-body" id="simBody">
                            <div class="sim-bubble bot" id="simMsg">Hello! How can I help you?</div>
                            <div class="sim-bubble user" id="simUserMsg" style="display:none;">I need help.</div>
                        </div>
                        <div class="sim-footer">
                            <div class="sim-input"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. INSTALLATION TAB -->
        <div id="install" class="tab-panel">
            <div class="header">
                <h1>Installation</h1>
                <p>Copy this code to your website.</p>
            </div>
            <div class="config-section">
                <div class="code-block">
                    <button class="copy-btn" onclick="copyEmbed()">Copy</button>
                    <pre id="embedCode">&lt;!-- ChatbotX Widget --&gt;
&lt;script 
  src="{{ request.host_url }}widget.js"
  data-site-id="{{ site_id }}"
  async
&gt;&lt;/script&gt;</pre>
                </div>
            </div>
        </div>

        <!-- 4. SIMULATOR TAB -->
        <div id="simulator" class="tab-panel">
            <div class="header">
                <h1>Live Simulator</h1>
                <p>Test your widget in a large, real-time environment.</p>
            </div>
            <div class="simulator-frame">
                <!-- Direct load of widget.html for full screen experience -->
                <iframe id="sim-frame" src="{{ url_for('widget_init') }}?api={{ request.host_url }}&site_id={{ site_id }}" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </div>

    </main>

    <script>
        // --- Navigation ---
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
            
            // Reload simulator if switching to it, to apply new branding settings
            if(tabId === 'simulator') {
                const iframe = document.getElementById('sim-frame');
                if(iframe) iframe.src = iframe.src;
            }
        }

        // --- Data Loading ---
        async function loadData() {
            // Load Config
            try {
                const confRes = await fetch('/admin/api/client/config');
                const confData = await confRes.json();
                const confForm = document.getElementById('configForm');
                
                if (confData.config) {
                    for (const [key, val] of Object.entries(confData.config)) {
                        if (confForm.elements[key]) confForm.elements[key].value = val;
                    }
                }
            } catch(e) { console.error("Config Load Error", e); }

            // Load Branding
            try {
                const brandRes = await fetch('/admin/api/client/branding');
                const brandData = await brandRes.json();
                const brandForm = document.getElementById('brandingForm');
                const b = brandData.branding;

                if (b) {
                    if(brandForm.elements['bot_name']) brandForm.elements['bot_name'].value = b.bot_name;
                    if(brandForm.elements['initial_message']) brandForm.elements['initial_message'].value = b.initial_message;
                    if(brandForm.elements['primary_color']) brandForm.elements['primary_color'].value = b.primary_color;
                    if(brandForm.elements['theme_mode']) brandForm.elements['theme_mode'].value = b.theme_mode;
                    if(brandForm.elements['position']) brandForm.elements['position'].value = b.position;
                    updatePreview();
                }
            } catch(e) { console.error("Branding Load Error", e); }
        }

        // --- Form Submission ---
        async function handleSave(e, url) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;
            
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(Object.fromEntries(new FormData(e.target)))
                });
                btn.innerText = 'Saved ‚úÖ';
                // Trigger preview update if it's branding
                if(url.includes('branding')) updatePreview();
            } catch(err) {
                btn.innerText = 'Error ‚ùå';
            }
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }

        document.getElementById('configForm').addEventListener('submit', (e) => handleSave(e, '/admin/api/client/config'));
        document.getElementById('brandingForm').addEventListener('submit', (e) => handleSave(e, '/admin/api/client/branding'));

        // --- Preview Logic (Mobile Mockup) ---
        function updatePreview() {
            const form = document.getElementById('brandingForm');
            const color = form.elements['primary_color'].value;
            const name = form.elements['bot_name'].value;
            const msg = form.elements['initial_message'].value;
            const theme = form.elements['theme_mode'].value;

            document.getElementById('colorHex').innerText = color;
            document.getElementById('simHeader').style.backgroundColor = color;
            document.getElementById('simName').innerText = name;
            document.getElementById('simMsg').innerText = msg;
            
            // Dark Mode Simulation
            const simBody = document.getElementById('simBody');
            if(theme === 'dark') {
                simBody.style.backgroundColor = '#1f2937';
                document.getElementById('simMsg').style.backgroundColor = '#374151';
                document.getElementById('simMsg').style.color = 'white';
            } else {
                simBody.style.backgroundColor = '#f3f4f6';
                document.getElementById('simMsg').style.backgroundColor = 'white';
                document.getElementById('simMsg').style.color = '#1f2937';
            }
        }

        document.getElementById('brandingForm').addEventListener('input', updatePreview);
        
        // --- Copy Logic ---
        function copyEmbed() {
            const code = document.getElementById('embedCode').innerText;
            navigator.clipboard.writeText(code);
            alert("Code copied to clipboard!");
        }

        // Init
        loadData();
    </script>
</body>
</html>